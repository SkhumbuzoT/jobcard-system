# jobcard_web_interface.py
import streamlit as st
import pandas as pd
from datetime import datetime
import os
import tempfile
from pathlib import Path
import sys

# Import your existing processor
from jobcard_processor import UnifiedJobCardProcessor, CONFIG

st.set_page_config(page_title="Job Card Creator", page_icon="üìã", layout="wide")

def main():
    st.title("üìã Job Card Creation Interface")
    st.markdown("Fill in the details below to generate a job card")
    
    # Create two columns for layout
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("Customer & Meter Details")
        
        # Customer details
        account_number = st.text_input("Contract Account Number*", 
                                      help="Enter the customer's account number")
        customer_name = st.text_input("Customer Name*")
        id_number = st.text_input("ID Number")
        
        # Address
        st.markdown("**Address**")
        house_no = st.text_input("House Number")
        street = st.text_input("Street")
        complex_name = st.text_input("Complex (if applicable)")
        suburb = st.text_input("Suburb/City")
        
    with col2:
        st.subheader("Meter Information")
        
        # The 6 fields you mentioned
        new_meter_number = st.text_input("1. New Meter Number*", 
                                        help="Enter the new meter number")
        old_meter_reading = st.text_input("2. Old Meter Reading*", 
                                         help="Enter the old meter reading")
        installation_date = st.date_input("3. Installation Date*", 
                                         value=datetime.now())
        status = st.selectbox("4. Status*", 
                             ["Completed", "Pending", "Rescheduled", "Cancelled"])
        
        st.markdown("---")
        st.subheader("Meter Photos (Google Drive URLs)")
        
        # Image URLs
        old_meter_image = st.text_input("5. Old Meter Image URL/ID*", 
                                       help="Google Drive file ID or link")
        new_meter_image = st.text_input("6. New Meter Image URL/ID*", 
                                       help="Google Drive file ID or link")
        
        # Helper for Google Drive IDs
        st.caption("‚ÑπÔ∏è Enter just the file ID from Google Drive share link")
        st.caption("Example: `1abc123...` from drive.google.com/file/d/1abc123.../view")
    
    # Additional fields
    with st.expander("Additional Information (Optional)"):
        col3, col4 = st.columns(2)
        with col3:
            meter_factor = st.text_input("Meter Factor", value="1")
            register = st.text_input("Register", value="1")
            digits = st.text_input("Number of Digits", value="5")
        with col4:
            device = st.text_input("Device Type", value="METER")
            comments = st.text_area("Additional Comments")
    
    # Preview and Submit
    st.markdown("---")
    
    if st.button("üöÄ Generate Job Card", type="primary", use_container_width=True):
        if not all([account_number, customer_name, new_meter_number, old_meter_reading]):
            st.error("Please fill in all required fields (*)")
        else:
            generate_job_card({
                'Contract Account': account_number,
                'Customer Name': customer_name,
                'ID Number': id_number,
                'House No': house_no,
                'Street': street,
                'Complex': complex_name,
                'City': suburb,
                'New Meter Number': new_meter_number,
                'Old Meter Readings': old_meter_reading,
                'Installation Date': installation_date.strftime("%Y-%m-%d"),
                'Status': status,
                'OldMeterImage': old_meter_image,
                'NewMeterImage': new_meter_image,
                'Meter Factor': meter_factor,
                'Register': register,
                'Digits': digits,
                'Device': device,
                'Comment': comments
            })

def generate_job_card(data):
    """Generate job card from form data"""
    with st.spinner("Creating job card..."):
        try:
            # Create a temporary Excel file with the single row
            temp_df = pd.DataFrame([data])
            temp_excel = tempfile.NamedTemporaryFile(delete=False, suffix='.xlsx')
            temp_df.to_excel(temp_excel.name, index=False)
            
            # Override the spreadsheet path temporarily
            original_spreadsheet = CONFIG['spreadsheet']
            CONFIG['spreadsheet'] = temp_excel.name
            
            # Run the processor
            processor = UnifiedJobCardProcessor()
            
            # We need to modify the processor to handle single rows
            # For now, let's capture output
            import io
            from contextlib import redirect_stdout
            
            f = io.StringIO()
            with redirect_stdout(f):
                processor.process_all()
            
            # Clean up
            os.unlink(temp_excel.name)
            CONFIG['spreadsheet'] = original_spreadsheet
            
            # Show success
            st.success("‚úÖ Job card created successfully!")
            
            # Find the generated file
            account = data['Contract Account']
            final_path = os.path.join(CONFIG['output_base'], 
                                     CONFIG['final_folder'], 
                                     f"FINAL_JOB_CARD_{account}.pdf")
            
            if os.path.exists(final_path):
                with open(final_path, "rb") as file:
                    st.download_button(
                        label="üì• Download Job Card PDF",
                        data=file,
                        file_name=f"JOB_CARD_{account}.pdf",
                        mime="application/pdf"
                    )
                
                # Show preview button
                st.info(f"üìÅ File saved to: {final_path}")
            else:
                st.warning("File generated but not found for download. Check the output folder.")
            
            # Show the processing output
            with st.expander("View processing details"):
                st.text(f.getvalue())
                
        except Exception as e:
            st.error(f"Error generating job card: {str(e)}")

if __name__ == "__main__":
    main()
